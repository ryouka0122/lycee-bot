#!/bin/sh

set -e

npm install --no-audit

export PATH="node_modules/.bin:node_modules/hubot/node_modules/.bin:$PATH"
export PORT=8101
export HUBOT_SLACK_TOKEN=`cat ./bin/HUBOT_SLACK_TOKEN.txt | head -1`

NAME=reimu
LOG_BASEDIR=/app/logs/lycee-bot

LOG_PATH=${LOG_BASEDIR}/${NAME}.log
OUT_PATH=${LOG_BASEDIR}/${NAME}.out
ERR_PATH=${LOG_BASEDIR}/${NAME}_error.log

FOREVER_OPTIONS="--minUptime 1000 --spinSleepTime 1000 --uid ${NAME}"
LOG_OPTIONS="-a -l ${LOG_PATH} -o ${OUT_PATH} -e ${ERR_PATH}"

forever start ${FOREVER_OPTIONS} ${LOG_OPTIONS} -c coffee node_modules/.bin/hubot --name "${NAME}" "$@"

exit $?
